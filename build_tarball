#!/usr/bin/bash

BASE=`dirname $0`
ABS_BASE=`cd $BASE && pwd`
WORKING=`pwd`
OUTDIR=${5:-$ABS_BASE}
DISPATCH_PATCHES=$3
PROTON_PATCHES=${4:-$ABS_BASE/PROTON-1845.patch}

wget ${1:-https://dist.apache.org/repos/dist/dev/qpid/dispatch/1.1.0-rc3/qpid-dispatch-1.1.0.tar.gz} -O qpid-dispatch.tar.gz
wget ${2:-http://archive.apache.org/dist/qpid/proton/0.22.0/qpid-proton-0.22.0.tar.gz} -O qpid-proton.tar.gz

mkdir qpid-dispatch-src qpid-proton-src build staging proton_build proton_staging_build proton_install
tar -zxf qpid-dispatch.tar.gz -C qpid-dispatch-src --strip-components 1
tar -zxf qpid-proton.tar.gz -C qpid-proton-src --strip-components 1
for patch in $PROTON_PATCHES; do
    patch -d qpid-proton-src -p1 < $patch
done;
for patch in $DISPATCH_PATCHES; do
    patch -d qpid-dispatch-src -p1 < $patch
done;

cd proton_build
cmake -DCMAKE_INSTALL_PREFIX=$WORKING/proton_install -DCMAKE_BUILD_TYPE=RelWithDebInfo -DBUILD_CPP=OFF -DBUILD_RUBY=OFF -DBUILD_GO=OFF $WORKING/qpid-proton-src/ && make && make install
cd $WORKING/proton_staging_build
cmake -DCMAKE_INSTALL_PREFIX=/usr -DBUILD_CPP=OFF -DBUILD_RUBY=OFF -DBUILD_GO=OFF -DSYSINSTALL_PYTHON=ON ../qpid-proton-src && make && make DESTDIR=$WORKING/staging/ install
cd $WORKING/build
CMAKE_PREFIX_PATH=$WORKING/proton_install cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo -DBUILD_DOCS=OFF -DCONSOLE_INSTALL=OFF -DCMAKE_INSTALL_PREFIX=/usr $WORKING/qpid-dispatch-src/ && make && make DESTDIR=$WORKING/staging/ install && tar -z -C $WORKING/staging/ -cf $OUTDIR/qpid-dispatch-image.tar.gz usr etc
